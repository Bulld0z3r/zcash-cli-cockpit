<html>

<head>
  <title>zcash-cli-cockpit</title>
  <meta charset="utf-8">
  <link href="../base1/cockpit.css" type="text/css" rel="stylesheet">
  <link href="jquery.dataTables.min.css" type="text/css" rel="stylesheet">
  <script src="../base1/jquery.js"></script>
  <script src="../base1/cockpit.js"></script>
  <script src="jquery.dataTables.min.js"></script>
  <style>
    ul.tab {
      list-style-type: none;
      margin: 0;
      padding: 0;
      overflow: hidden;
      border: 1px solid #ccc;
      background-color: #f1f1f1;
    }
    
    ul.tab li {
      float: left;
    }
    
    ul.tab li a {
      display: inline-block;
      color: black;
      text-align: center;
      padding: 5px 12px;
      text-decoration: none;
      transition: 0.3s;
      font-size: 17px;
    }
    
    ul.tab li a:hover {
      background-color: #ddd;
    }
    
    ul.tab li a:focus,
    .active {
      background-color: #ccc;
    }
    
    .tabcontent {
      display: none;
      padding: 6px 12px;
      border: 1px solid #ccc;
      border-top: none;
    }
    
    .roundedbox {
      padding: 6px 12px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    
    .zcash-dialog-modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgb(0, 0, 0);
      background-color: rgba(0, 0, 0, 0.4);
    }
    
    .zcash-dialog-modal-content {
      background-color: #fefefe;
      margin: 2% auto;
      padding: 0px 16px 8px 16px;
      border: 1px solid #888;
      width: 80%;
    }
    
    .zcash-dialog-close {
      color: #aaa;
      float: right;
      font-size: 24px;
      font-weight: bold;
      padding-top: 0px;
    }
    
    .zcash-dialog-close:hover,
    .zcash-dialog-close:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }
  </style>
</head>

<body class="page-ct">
  <script src="utf8.js"></script>

  <div id="zcash-dialog-model" class="zcash-dialog-modal">
    <div class="zcash-dialog-modal-content">
      <span class="zcash-dialog-close">x</span>
      <h2 id="zcash-dialog-title">...</h2>
      <hr />
      <p><span id="zcash-dialog-text">...</span></p>
    </div>
  </div>

  <div class="container-fluid">

    <img style="float: left; height: 42px; padding: 0px; margin: 0px; padding-right: 12px;" src="zcash-logo-black.png" alt="zcash logo" />
    <div style="padding-top: 6px;">
      <h2 style="margin-top: 0px; padding-top: 0px; float: left;">cockpit plugin (beta2-testnet)</h2>
      <button class="btn btn-default btn-primary" style="margin-left:6px;" id="zcash-refresh">Reload</button>
    </div>
    <div style="clear: both;"> </div>
    <hr style="margin-top: 6px; margin-bottom: 6px;" />

    <table>
      <tr>
        <td style="min-width: 280px;">

          <p style="float: left; padding-left: 6px; padding-right: 12px; padding-top: 4px;">
            Balance: <b><span id="zcash-balance">...</span></b> TAZ<br /> Protected: <b><span id="zcash-pbalance">...</span></b> TAZ<br /> Unprotected: <b><span id="zcash-tbalance">...</span></b> TAZ<br />
          </p>
          <p style="float: left; padding-top: 4px; padding-right: 12px;">
            Block Height: <b><span id="zcash-block">...</span></b><br /> Difficulty: <b><span id="zcash-difficulty">...</span></b><br /> Network Hash/s: <b><span id="zcash-nethps">...</span></b><br />
          </p>
          <p style="float: left; padding-top: 4px; padding-right: 12px;">
            Connections: <b><span id="zcash-connections">...</span></b><br /> Recv: <b><span id="zcash-totalrecv">...</span></b><br /> Sent: <b><span id="zcash-totalsend">...</span></b><br />
          </p>
        </td>
      </tr>
      <tr>
        <td style="padding-left: 6px; padding-bottom: 12px;">
          <span id="zcash-errors" style="color: red;">...</span>
        </td>
      </tr>
    </table>

    <a name="tabs"></a>

    <ul class="tab">
      <li><a href="#tabs" class="tablinks" onclick="showTab(event, 'zcashTabBlocks')">Blockchain</a></li>
      <li><a href="#tabs" class="tablinks" onclick="showTab(event, 'zcashTabProtect')">Protect</a></li>
      <li><a href="#tabs" class="tablinks" onclick="showTab(event, 'zcashTabSend')">Send</a></li>
      <li><a href="#tabs" class="tablinks" onclick="showTab(event, 'zcashTabConsole')">Console</a></li>
      <li><a href="#tabs" class="tablinks" onclick="showTab(event, 'zcashTabMining')">Mining</a></li>
    </ul>

    <div id="zcashTabTransactions" class="tabcontent">
      <p>
        <label>Recent Unprotected Transactions</label><br />
        <span id="zcash-transaction-info">...</span>
      </p>
    </div>

    <div id="zcashTabProtect" class="tabcontent">

      <p>Your mined coins are currently stored in a t-addr. Let's make them private by sending them to a z-addr.</p>

<table class="cockpit-form-table">
<tr>
<td valign="top">
        <div class="roundedbox">
          <label for="zcash-protect-taddresses">From Address</label><br />
          <select id="zcash-protect-taddresses" style="margin-bottom: 6px;">
<option value="tn1">taddr</option>
</select>
          <br />

          <label for="zcash-protect-zaddresses">To Address</label><br />
          <select id="zcash-protect-zaddresses" style="margin-bottom: 6px;">
<option value="tn1">zaddr</option>
</select><br />
          <label for="zcash-protect-extrafee">Extra Fee</label><br />
          <input id="zcash-protect-extrafee" type="text" value="0.0001" />
          <br />
          <div style="margin-top: 8px; margin-bottom: 4px;">
            <button class="btn btn-default btn-primary" id="zcash-protect">Protect</button>
          </div>
        </div>
</td>
<td valign="top" style="padding-left: 8px;">

      <p>
        <label>Unprotected Coins</label> <a href="#tabs" class="tablinks" onclick="showTab(event, 'zcashTabTransactions')">(Recent Unprotected Transactions)</a><br />
        <span id="zcash-protect-taddresses-info">...</span>
      </p>

</td>
</tr>
</table>
        <p> </p>

    </div>

    <div id="zcashTabSend" class="tabcontent">

      <p>Send your private z-addr coins to the specified t-addr or z-addr. Note, memos are not supported when sending to a t-addr.</p>

      <table class="cockpit-form-table" width = "100%">
        <tr>
          <td valign="top" style="white-space: nowrap;">

            <div style="padding-bottom: 6px;">
              Sender
            </div>

            <div class="roundedbox">
              <label>From Address</label> <br />
              <select id="zcash-send-from">
<option value="tn1">addr</option>
</select><br />
              <label>Extra Fee</label> <br />
              <input type="text" id="zcash-send-extrafee" value="0.0001" />
            </div>

            <p> </p>
            <button class="btn btn-default btn-primary" id="zcash-send">Send</button>
            <p> </p>

          </td>
          <td valign = "top" style="padding-left: 6px;" width="99%">

            <div style="padding-bottom: 6px;">
              Recipients (<span id="zcash-send-to-count">1</span>)
              <a href="#" id="zcash-send-add">Add More</a>
            </div>

            <div id="zcash-send-to-wrapper" style="margin: 0px; padding: 0px;">

              <div class="roundedbox" style="display: inline-block;">
                <label>To Address</label> <br />
                <input type="text" name="zcash-send-to[]" class="zcash-send-to" /> <br />
                <label>Send Amount</label> <br />
                <input type="text" name="zcash-send-amount[]" class="zcash-send-amount" value="1.00" /> <br />
                <label>Memo</label> <br />
                <input type="text" name="zcash-send-memo[]" class="zcash-send-memo" /> <br />
              </div>

            </div>

          </td>
        </tr>
        <tr>
          <td colspan="2" style="padding-top: 8px;">

      <p>
        <label>Protected Coins</label> <i>(Double Click on z-addr to view private transactions)</i><br />
        <span id="zcash-send-zaddresses-info">...</span>
      </p>

          </td>
        </tr>
      </table>

      <p> </p>

    </div>

    <div id="zcashTabConsole" class="tabcontent">
      <p>Send commands directly to the zcash-cli. Note, the command argument syntax is not the same as working from a linux command shell. See below.</p>
      <p>Proper Syntax: <b>z_sendmany TADDR [{"address": "ZADDR", "memo": "48656c6c6f20ceb221", "amount": 1.23}]</b><br /> DoNotSend: z_sendmany "TADDR" "[{\"address\": \"ZADDR\", \"memo\": \"48656c6c6f20ceb221\", \"amount\": 1.23}]"</p>
      <p>Basic Rules: Do not encapsulate entire arguments in quotes. Do not escape quotes in arguments.</p>
      <table class="cockpit-form-table" style="width: 100%;">
        <tr>
          <td style="padding-right: 6px; width: 100%;">
            <label class="control-label">Command: </label>
            <input type="text" id="zcash-cli-input-cmd" style="width: calc(100% - 134px);" value="help" />
            <button class="btn btn-default btn-primary" id="zcash-cli-input-run">Run</button>
          </td>
        </tr>
      </table>

    </div>

    <div id="zcashTabMining" class="tabcontent">

      <pre style="color: red;">zcashd bug? applying settings here causes zcashd to crash after a short period.</pre>

      <table class="cockpit-form-table">
        <tr>
          <td>
            generate
            <select id="zcash-mine-generate">
<option value="true">true</option>
<option value="false">false</option>
</select> genproclimit
            <select id="zcash-mine-nproc">
<option value="1">1</option>
</select>
            <button class="btn btn-default btn-primary" id="zcash-mine-start">Apply</button>
          </td>
        </tr>
      </table>

    </div>

    <div id="zcashTabWait" class="tabcontent">
     <span id="zcash-wait"></span>
     <span id="zcash-wait-status"></span>
     <div style="clear: both;"> </div>
    </div>

    <div id="zcashTabBlocks" class="tabcontent">
      <p>History of the last 20 blocks observed will be shown here.</p>
      <table id="zcash-table-blocks" class="display" width="100%"></table>
      <table id="zcash-table-transactions" class="display" width="100%"></table>
    </div>


    <pre id="zcash-cli-output" style="border-top: 0px;">...</pre>

    <p> </p>

    <p>
      <span id="zcash-pid" style="float: left; padding-right: 6px;">...</span>
      <span id="zcash-timems">...</span>
    </p>

    <p>
      <a target="_blank" href="http://z.cash/">z.cash</a>:
      <a target="_blank" href="https://z.cash/support/faq.html">FAQ</a> |
      <a target="_blank" href="https://forum.z.cash/">Forums</a> |
      <a target="_blank" href="https://github.com/zcash/zcash/wiki/Beta-Guide">Beta Guide</a> |
      <a target="_blank" href="https://github.com/zcash/zcash/wiki/Mining-Guide">Mining Guide</a> |
      <a target="_blank" href="https://github.com/zcash/zcash/blob/v1.0.0-beta2/doc/payment-api.md">Payment API</a>
    </p>

    <p> </p>
  </div>

  <script>
    //
    // Config Variables
    //
    var zcashcli = "zcash-cli";
    var zcash_getinfo_rate = 30000;

    //
    // Global Variables
    //
    var zcash_isrunning = false;
    var zcash_monitor_opid = ""; // operation id of transaction
    var zcash_getinfo_timeout = 0; // id for setTimeout

    var zcash_op_id;
    var zcash_cli_op_running = false;

    // arrays to hold balances for addressses
    var unspent_balances = {}; // t-addr's
    var protected_balances = {}; // z-addr's
    var protected_balance = 0.0; // z-addr total balance

    // global zcash-cli output
    var zcash_output = $("#zcash-cli-output");

    var zcash_wait = $("#zcash-wait");
    var zcash_wait_status = $("#zcash-wait-status");

    // general zcash information
    var ztbalance_output = $("#zcash-tbalance");
    var zpbalance_output = $("#zcash-pbalance");
    var zbalance_output = $("#zcash-balance");

    var zblock_output = $("#zcash-block");
    var zdifficulty_output = $("#zcash-difficulty");
    var zerrors_output = $("#zcash-errors");
    var zconnections_output = $("#zcash-connections");

    var ztotalrecv_output = $("#zcash-totalrecv");
    var ztotalsend_output = $("#zcash-totalsend");
    var ztimems_output = $("#zcash-timems");
    var znethps_output = $("#zcash-nethps");

    var zcash_transaction_info = $("#zcash-transaction-info");

    // mining tab
    var zcash_mine_generate = $("#zcash-mine-generate");
    var zcash_mine_nproc = $("#zcash-mine-nproc");

    // protect tab
    var zcash_protect_taddresses_info = $("#zcash-protect-taddresses-info")
    var zcash_protect_taddresses = $("#zcash-protect-taddresses")
    var zcash_protect_zaddresses = $("#zcash-protect-zaddresses");
    var zcash_protect_extra_fee = $("#zcash-protect-extrafee");
    var zcash_protect_amount = $("#zcash-protect-amount");

    // send tab
    var zcash_send_to_max = 8;
    var zcash_send_to_count = 1;

    var zcash_send_to_count_output = $("#zcash-send-to-count");
    var zcash_send_zaddresses_info = $("#zcash-send-zaddresses-info");
    var zcash_send_from = $("#zcash-send-from");
    var zcash_send_extra_fee = $("#zcash-send-extrafee");
    var zcash_send_to = $(".zcash-send-to");
    var zcash_send_amount = $(".zcash-send-amount");
    var zcash_send_memo = $(".zcash-send-memo");

    var zcash_sending_coins = false;
    var zcash_send_to_wrapper = $("#zcash-send-to-wrapper");

    var zcash_dialog_modal = document.getElementById('zcash-dialog-model');
    var zcash_dialog_title = $("#zcash-dialog-title");
    var zcash_dialog_text = $("#zcash-dialog-text");
    var zcash_dialog_closebtn = document.getElementsByClassName("zcash-dialog-close")[0];
    zcash_dialog_closebtn.onclick = function() {
      zcash_dialog_modal.style.display = "none";
    }

    var zcash_blocks_table = $('#zcash-table-blocks').DataTable( {
        searching: false,
        lengthChange: false,
        paging: false,
        info: false,
        scrollY: "200px",
        scrollCollapse: true,
        order: [[ 0, "desc" ]],
        columns: [
            { title: "Blocks" },
            { title: "Timestamp" },
            { title: "Trnxs" },
            { title: "Size" }
        ]
    } );

    var zcash_transaction_table = $("#zcash-table-transactions").DataTable( {
        searching: false,
        lengthChange: false,
        paging: false,
        info: false,
        order: [[ 0, "desc" ]],
        columns: [
            { title: "Transaction Id" },
            { title: "T-ADDR Value" }
        ]
    } );

    //
    // UI Button Events
    //
    $("#zcash-refresh").on("click", begin_application);
    $("#zcash-send").on("click", zcash_onClickSend);
    $("#zcash-protect").on("click", zcash_onClickProtect);
    $("#zcash-mine-start").on("click", zcash_mine_start);
    $("#zcash-cli-input-run").on("click", zcash_cli_input_run);

    $("#zcash-send-add").on("click", zcash_send_add_more);

    zcash_send_to_wrapper.on("click", ".remove_field", function(e) {
      //user click on remove text
      e.preventDefault();
      $(this).parent('div').remove();
      zcash_send_to_count--;
      zcash_send_to_count_output.empty();
      zcash_send_to_count_output.append(zcash_send_to_count);
    });

    // use "ready" event to begin_application()
    $(document).ready(function() {
      begin_application();
    });

    //
    //  Helper Functions
    //

    String.prototype.hexEncode = function() {
      var str = '';
      for (var i = 0; i < this.length; i++) {
        str += this[i].charCodeAt(0).toString(16);
      }
      return str;
    };
    String.prototype.hexDecode = function() {
      for (var bytes = [], c = 0; c < this.length; c += 2) {
        bytes.push(parseInt(this.substr(c, 2), 16));
      }
      return utf8tostr(bytes);
    };

    function utf8tostr(arr) {
      for (var i = 0, l = arr.length, s = '', c; c = arr[i++];)
        s += String.fromCharCode(
          c > 0xdf && c < 0xf0 && i < l - 1 ?
          (c & 0xf) << 12 | (arr[i++] & 0x3f) << 6 | arr[i++] & 0x3f :
          c > 0x7f && i < l ?
          (c & 0x1f) << 6 | arr[i++] & 0x3f :
          c
        );
      return s;
    }

    function isEmpty(data) {
      return (data == null || data == 0 || data.length == null || data.toString().length == 0);
    };

    function round(number) {
      return Math.round(number * 100000000) / 100000000;
    }

    function showDialog(title, text) {
      zcash_dialog_modal.style.display = "block";
      zcash_dialog_title.empty();
      zcash_dialog_title.append(title);
      zcash_dialog_text.empty();
      zcash_dialog_text.append(text);
    }

    function showTab(evt, cityName) {
      var i, tabcontent, tablinks;
      tabcontent = document.getElementsByClassName("tabcontent");
      for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
      }
      tablinks = document.getElementsByClassName("tablinks");
      for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
      }
      document.getElementById(cityName).style.display = "block";
      if (evt != null) {
        evt.currentTarget.className += " active";
      }
    }

    function proc_zcash_cli_fail(e) {
      zcash_monitor_opid = "";
      zcash_cli_op_running = false;
      if (zcash_sending_coins == true) {
        zcash_sending_coins = false;
        zcash_wait_operation_fail(e.toString());
      } else {
        alert(e);
      }
    }

    //
    //  Main Application Entry Point
    //

    function begin_application() {
      if (zcash_cli_op_running == true) {
        alert("Operation already in progress...");
        return;
      }
      zcash_isrunning = false;
      zcash_monitor_opid = "";
      zcash_sending_coins = false;

      unspent_balances = {};
      protected_balances = {};
      zcash_send_zaddresses_info.empty();

      zcash_cli_op_running = true;
      var cmd = ["pidof", "zcashd"];
      var proc = cockpit.spawn(cmd, {
        err: 'out'
      });
      proc.fail(check_zcash_detection_result);
      proc.done(check_zcash_detection_result);
      proc.stream(do_zcashd_detection);
    }

    function check_zcash_detection_result() {
      if (!zcash_isrunning) {
        alert("zcashd is not running!");
        zcash_cli_op_running = false;
        return;
      }
      // populate nproc select options
      zcash_cli_op_running = true;
      var cmd = ["nproc"];
      var proc = cockpit.spawn(cmd, {
        err: 'out'
      });
      proc.done(proc_zcash_mine_nproc);
      proc.fail(proc_zcash_cli_fail);
    }

    function do_zcashd_detection(data) {
      if (!isEmpty(data)) {
        // did we get a pid of zcashd?
        if (parseInt(data) > 0) {
          // zcashd is running
          zcash_isrunning = true;
          // show pid of zcashd
          $("#zcash-pid").empty();
          $("#zcash-pid").append("(zcashd pid: " + data.trim() + ")");
        }
      }
    }

    function proc_zcash_mine_nproc(data) {
      zcash_mine_nproc.empty();
      zcash_mine_nproc.append($("<option/>", {
        value: 1,
        text: 1
      }));
      for (i = 1; i < parseInt(data); i++) {
        zcash_mine_nproc.append($("<option/>", {
          value: i + 1,
          text: i + 1
        }));
      }
      zcash_mine_nproc.val(parseInt(data));

      zcash_cli_op_running = false;

      zcash_cli_getinfo();
      zcash_cli_getmininginfo();

      zcash_cli_listunspent();
      zcash_cli_listtransactions();

      zcash_cli_list_zaddr();
    }

    //
    // 	zcash-cli getinfo
    //
    function zcash_cli_getinfo() {
      if (zcash_getinfo_timeout != 0) {
        clearTimeout(zcash_getinfo_timeout);
      }
      var cmd = [zcashcli, "getinfo"];
      var proc = cockpit.spawn(cmd, {
        err: 'out'
      });
      proc.done(proc_zcash_cli_getinfo);
      proc.fail(proc_zcash_cli_fail);
    }

    var lastblock = 0;

    function proc_zcash_cli_getinfo(data) {
      var jobj = JSON.parse(data);

      zdifficulty_output.empty();
      zblock_output.empty();
      zerrors_output.empty();
      zconnections_output.empty()

      zblock_output.append(document.createTextNode(jobj["blocks"]));
      zdifficulty_output.append(document.createTextNode(jobj["difficulty"]));
      zerrors_output.append(document.createTextNode(jobj["errors"]));
      zconnections_output.append(document.createTextNode(jobj["connections"]));

      zcash_cli_z_gettotalbalance();

      // detect new blocks and do extra work
      if (lastblock != parseInt(jobj["blocks"])) {

        var missedblocks = (lastblock == 0 ? 3 : Math.min(10, (parseInt(jobj["blocks"]) - lastblock)));

        lastblock = parseInt(jobj["blocks"]);
        
        for (i=((lastblock + 1) - missedblocks); i < lastblock; i++) {
           zcash_blocks_table.row.add([i,"...","...","..."]);
           zcash_cli_z_getblockinfo(i);
        }
        zcash_blocks_table.row.add([lastblock,"...","...","..."]);
        zcash_cli_z_getblockinfo(lastblock);

        if (zcash_blocks_table.rows().data().length > 20) {
           zcash_blocks_table.rows(0).remove();
        }
        zcash_blocks_table.draw();

        if (zcash_transaction_table.rows().data().length > 20) {
          while (zcash_transaction_table.rows().data().length > 20) {
             zcash_transaction_table.rows(0).remove().draw();
          }
        }
      }
    }

    function zcash_cli_z_getblockinfo(block) {
      var cmd = [zcashcli, "getblockhash", block.toString()];
      var proc = cockpit.spawn(cmd, {
        err: 'out'
      });
      proc.done(proc_zcash_cli_z_getblockinfo);
      proc.fail(proc_zcash_cli_fail);
    }
    function proc_zcash_cli_z_getblockinfo(bhash) {
      // look info up for block hash
      var cmd = [zcashcli, "getblock", bhash.toString().trim()];
      var proc = cockpit.spawn(cmd, {
        err: 'out'
      });
      proc.done(proc_zcash_cli_z_getblock);
      proc.fail(proc_zcash_cli_fail);
    }
    function getblockrowindex(block) {
      var indexes = zcash_blocks_table.rows().eq( 0 ).filter( function (rowIdx) {
        return zcash_blocks_table.cell( rowIdx, 0 ).data() == block ? true : false;
      } );
      return indexes[0];
    }
    function proc_zcash_cli_z_getblock(data) {
      var jobj = JSON.parse(data);

      var rowData = getblockrowindex(parseInt(jobj["height"]));
      zcash_blocks_table.cell(rowData, 1).data(parseInt(jobj["time"]));
      zcash_blocks_table.cell(rowData, 2).data($(jobj["tx"]).size());
      zcash_blocks_table.cell(rowData, 3).data(parseInt(jobj["size"]));
      zcash_blocks_table.draw();
      
      $(jobj["tx"]).each(function( index ) {
        zcash_transaction_table.row.add([jobj["tx"][index], ""]);
        zcash_cli_z_gettxout(jobj["tx"][index], 0);
      });
      zcash_transaction_table.draw();
      // TODO
/*
{
    "hash" : "0012652590ad920bca24f4dcc5d8839ad577edf8e750313e6e1c1a4581de7eb1",
    "confirmations" : 2,
    "size" : 1620,
    "height" : 2853,
    "version" : 4,
    "merkleroot" : "82e69a0040050f4783ab433464b8871a93ed43d5c1dc82bee441c5e04a325811",
    "tx" : [
        "82e69a0040050f4783ab433464b8871a93ed43d5c1dc82bee441c5e04a325811"
    ],
    "time" : 1476051474,
    "nonce" : "00000138b524c6bff1568f319d6473e50f5f701ae1df0fc88b0d0c5349f50000",
    "solution" : "0040466522caaea0de764343e050c12ce36118b6c4096e79c1a34ea83fe343c18edc16b014db2e341e8f0bee47246d12db64bb27d430e07f321605b03a76cc1176fd2e62af65b9fc18a1a3094bc6750d40cf9a02039da643bf283b1fde7a11c9d751e317a4609e52a3131b74375c28fdc17605241cbba626818fc7334eb809c8271d22533622a2f083623269804501b091b4dc0d99e11e8198b20d454c84b955722b36423c59ce1902739359e708bebe5854c427e1bb6a498f29163c0d0c6ff86c5ec39569601041fd963713176c72fc514423c55b11ab8e4fd713e3a43bf128e985aed876a0cd2d441e91e4d6fda8c37a46e2eebb9209f6af54fd650a3b087119446587dc3730bf0dbeb67cbfc6f754b912f812ab9d8fa33ff09d57dedce4ad563aed95d90e0d9c0d6fea9c05fb2e9b8a4eddf3cd76ca845b280113f6bbea804728409047a5ac6041c37e09b6fa036801fd03a57417f2c5cf5a00b1abc59e9443bfea7b471e37a3869cde72dd63ff055134477049db5651d59811c1e476aaf394f1fafaea31f3e9231306185c11e114d43d84c3d5aa17672987e640cf9716909d7688ec095417c634cd64d5c2f51293cf445544ce78387a8c17c65552b2496c8be3a461e53aa94f093cccb9c1770ad763b9646a5925622556d24beb2a09dc8bcf45ed140134d54e1444a72a34f2ee3359939972b8bc11b50354759a2e5378cf497951d683d9f00ccaba3278350ffba456b6e1bd19d710e19ebf9801f539b9bb10e026c2cc52585048bb8425b506aad57b2ac9ed19602d356292b9144e11b3a4fec79d667f8b8ea7aa5d87e90e23ce251abc04e1f174177bc9467dd30f145ea3cf231ec2b524176e2b5506748646f3196bc174bf71bf1127f75c7a5ab1d12972856d87cfa60977e13726e66771bbf7522af53f58ede78e0f71f4aa208a3eb9fb012b16cf064adf8194dbd50dde33c4e19746fe635714a96cfd6e07dcc34cb857f7c0509df20c253bac8509de5b8f10e4368364b672ed32aa50e1578ef60e2b0f3caa93684d1dbedc2f7435bda31d221e2ddf4d6806d46963775650ceb2fa137d91c32771dd059969ee0d3fbfd1209404b37dab538ca27011aae3ea77f40532159a0a6399fb5f7dd3fcf12ffe982b588dbe4bbb731e25c6d9f50127e785592b6977034eacd7974c1704b77c166e08b0baa87ad14cad90ed6103cbcd0a2f6cfc3e9f13f383ffa4cf9718ddea9182f0151f23901e7ee1b8a847caf897a191f3f69a90d92ced9efefe21d623910b133b5962366480aca9b28ef99cf7e1e60dfc4e84841a618cee9e251c4fdd374e7a56f8ab4028b1d3d0eea4cbe1a161043e95351c1625fc11ba0e1d23ed05cc6eb053caa085268ee680abd1539e94a6264a2d54b39baaef6c00a496953711d543031a5c8f036b3bc1532edcf9b6ff627fe4a274bcc6ab09cfbb321d74d4cdae0d41f8d3233ac63f2bc7329dbc716e078a3f45cb446f99d02d73b30ef9023d8436cd756e1f929d5ae19548199f18c3df2661c8365f3eb83dd40c6fa19857d00f97fa8a89ab327ea7238bbd9fa006326d8d3693d4c2351d74742ed3ce028d435752b2ff182f479b9ae1fba5bc03a3e281ca45f1ccb83f4c433e003b1ce13ed17dff3b8583b1349812c4dd5bc62907c452fc5be95f0fe3fbf1f833b727f20808b3be33144bd434ed856ff5ddb561f87ea55645a9add8622c1158741e5f5610ad5428f299a92552722abf37b94e1c8f0cb7ff194f61833ae3a114ef584323101efbc1193f624a64981d22fbefa69e253c5e09bfdf3f5c0926f42a9c46978f2f423d3271f0556804fa1835a7731afc025f38497ca52fd5937538becc28e0d0ee54ea31e773fca3cff77590c9556cc0f31021dcf5134387",
    "bits" : "1f614024",
    "difficulty" : 39.64048143,
    "chainwork" : "00000000000000000000000000000000000000000000000000000000001f3259",
    "previousblockhash" : "000cddf688f612567afa146f06d058ebfcdcbf4bc7dec833db5865d2efe710e7",
    "nextblockhash" : "000164df17a43f202888c2e1789f82b68bc02d18a481c70b3d62bd0e0349b6d7"
}
*/
    }

    function zcash_cli_z_gettxout(txid, n) {
      var cmd = [zcashcli, "gettxout", txid, n];
      var proc = cockpit.spawn(cmd, {
        err: 'out'
      });
      proc.done(function(data) {
        proc_zcash_cli_gettxout(txid, n, data);
      });
      proc.fail(proc_zcash_cli_fail);
    }
/*
{
    "bestblock" : "004a2fcc5ae0ece50cb65d3b0450a59ccd4c4ce31b5a6db891b0e067488b74d2",
    "confirmations" : 1,
    "value" : 0.36900000,
    "scriptPubKey" : {
        "asm" : "OP_HASH160 ef775f1f997f122a062fff1a2d7443abd1f9c642 OP_EQUAL",
        "hex" : "a914ef775f1f997f122a062fff1a2d7443abd1f9c64287",
        "reqSigs" : 1,
        "type" : "scripthash",
        "addresses" : [
            "t2UNzUUx8mWBCRYPRezvA363EYXyEpHokyi"
        ]
    },
    "version" : 1,
    "coinbase" : true
}
*/
    function gettransactionrowindex(txid) {
      var indexes = zcash_transaction_table.rows().eq( 0 ).filter( function (rowIdx) {
        return zcash_transaction_table.cell( rowIdx, 0 ).data() == txid ? true : false;
      } );
      return indexes[0];
    }
    function proc_zcash_cli_gettxout(txid, n, data) {
      var jobj = JSON.parse("["+data+"]")[0];
      if (jobj != null) {

/*
        var addresses = "";
        $(jobj["scriptPubKey"]["addresses"]).each(function( index ) {
          addresses += jobj["scriptPubKey"]["addresses"][index].toString() + ",";
        });
        addresses = addresses.substr(0, addresses.length - 1);        
*/

        var rowData = gettransactionrowindex(txid);
        var amount = parseFloat(jobj["value"]);
        if (!isEmpty(zcash_transaction_table.cell(rowData, 1).data()))
            amount = amount + parseFloat(zcash_transaction_table.cell(rowData, 1).data());

        zcash_transaction_table.cell(rowData, 1).data(round(amount).toString());
        zcash_transaction_table.draw();

        // total up all for this tx
        zcash_cli_z_gettxout(txid, n+1);

      }
    }

    //
    // 	zcash-cli z_gettotalbalance
    //
    function zcash_cli_z_gettotalbalance() {
      var cmd = [zcashcli, "z_gettotalbalance"];
      var proc = cockpit.spawn(cmd, {
        err: 'out'
      });
      proc.done(proc_zcash_cli_z_gettotalbalance);
      proc.fail(proc_zcash_cli_fail);
    }

    var zcash_balances = [];

    function proc_zcash_cli_z_gettotalbalance(data) {
      var jobj = JSON.parse(data);

      ztbalance_output.empty();
      zpbalance_output.empty();
      zbalance_output.empty();

      zcash_balances = [jobj["transparent"], jobj["private"], jobj["total"]];

      ztbalance_output.css("color", "");
      zpbalance_output.css("color", "");
      zbalance_output.css("color", "");

      ztbalance_output.append(document.createTextNode(jobj["transparent"]));
      zpbalance_output.append(document.createTextNode(jobj["private"]));
      zbalance_output.append(document.createTextNode(jobj["total"]));

      zcash_cli_z_gettotalbalance_unconfirmed();
    }

    function zcash_cli_z_gettotalbalance_unconfirmed() {
      var cmd = [zcashcli, "z_gettotalbalance", "0"];
      var proc = cockpit.spawn(cmd, {
        err: 'out'
      });
      proc.done(proc_zcash_cli_z_gettotalbalance_unconfirmed);
      proc.fail(proc_zcash_cli_fail);
    }

    function proc_zcash_cli_z_gettotalbalance_unconfirmed(data) {
      var jobj = JSON.parse(data);

      var uconf_zcash_balances = [jobj["transparent"], jobj["private"], jobj["total"]];

      if (uconf_zcash_balances[0] != zcash_balances[0]) {
        ztbalance_output.css("color", "red");
        ztbalance_output.empty();
        ztbalance_output.append("*" + uconf_zcash_balances[0].toString());
        zerrors_output.empty();
        zerrors_output.append("* Showing unconfirmed balance because of immature transaction.");
      }

      if (uconf_zcash_balances[1] != zcash_balances[1]) {
        zpbalance_output.css("color", "red");
        zpbalance_output.empty();
        zpbalance_output.append("*" + uconf_zcash_balances[1].toString());
        zerrors_output.empty();
        zerrors_output.append("* Showing unconfirmed balance because of immature transaction.");
      }

      if (uconf_zcash_balances[2] != zcash_balances[2]) {
        zbalance_output.css("color", "red");
        zbalance_output.empty();
        zbalance_output.append("*" + uconf_zcash_balances[2].toString());
        zerrors_output.empty();
        zerrors_output.append("* Showing unconfirmed balance because of immature transaction.");
      }

      zcash_cli_getnettotals();
    }

    //
    // 	zcash-cli getnettotals
    //
    function zcash_cli_getnettotals() {
      var cmd = [zcashcli, "getnettotals"];
      var proc = cockpit.spawn(cmd, {
        err: 'out'
      });
      proc.done(proc_zcash_cli_getnettotals);
      proc.fail(proc_zcash_cli_fail);
    }

    function proc_zcash_cli_getnettotals(data) {
      var jobj = JSON.parse(data);

      ztotalrecv_output.empty();
      ztotalsend_output.empty();
      ztimems_output.empty();

      var recvbytes = parseFloat(jobj["totalbytesrecv"]);
      var sentbytes = parseFloat(jobj["totalbytessent"]);
      // convert from bytes to megabytes
      recvbytes = recvbytes / 1024;
      recvbytes = recvbytes / 1024;
      sentbytes = sentbytes / 1024;
      sentbytes = sentbytes / 1024;

      var timems = new Date(parseInt(jobj["timemillis"]));
      ztotalrecv_output.append(document.createTextNode(recvbytes.toFixed(3) + " MB"));
      ztotalsend_output.append(document.createTextNode(sentbytes.toFixed(3) + " MB"));
      ztimems_output.append(document.createTextNode(timems.toTimeString()));

      schedule_zcash_cli_getinfo_refresh();
    }

    function schedule_zcash_cli_getinfo_refresh(method) {
      if (zcash_getinfo_timeout != 0) {
        clearTimeout(zcash_getinfo_timeout);
      }
      zcash_getinfo_timeout = setTimeout(zcash_cli_getinfo, zcash_getinfo_rate);
    }

    //
    // 	Mining Tab
    //

    //
    // 	zcash-cli setgenerate
    //
    function zcash_mine_start() {
      var cmd = [zcashcli, "setgenerate", zcash_mine_generate.val(), zcash_mine_nproc.val()];
      var proc = cockpit.spawn(cmd, {
        err: 'out'
      });
      proc.done(proc_zcash_mine_start_done);
      proc.fail(proc_zcash_cli_fail);
      zcash_output.empty();
      zcash_output.append(document.createTextNode(cmd.join(" ")));
    }

    function proc_zcash_mine_start_done() {
      setTimeout(zcash_cli_getmininginfo, 1000);
    }

    //
    // 	zcash-cli getmininginfo
    //
    function zcash_cli_getmininginfo() {
      var cmd = [zcashcli, "getmininginfo"];
      var proc = cockpit.spawn(cmd, {
        err: 'out'
      });
      proc.done(proc_zcash_cli_getmininginfo);
      proc.fail(proc_zcash_cli_fail);
      zcash_output.empty();
    }

    function proc_zcash_cli_getmininginfo(data) {
      var jobj = JSON.parse(data);
      var nproc = parseInt(jobj["genproclimit"]);

      zcash_mine_generate.val((jobj["generate"] == true ? "true" : "false"));
      zcash_mine_nproc.val(nproc);

      znethps_output.empty();
      znethps_output.append(jobj["networkhashps"]);

      var text = "";
      if (jobj["generate"] == true) {
        text += "Mining enabled, using " + nproc + " processors.";
      } else {
        text += "Mining is not enabled.";
      }

      zcash_output.append(document.createTextNode(text));
    }

    //
    // Protect Tab
    //

    //
    // 	zcash-cli listunspent
    //
    function zcash_cli_listunspent() {
      var cmd = [zcashcli, "listunspent"];
      var proc = cockpit.spawn(cmd);
      proc.done(proc_zcash_cli_listunspent);
      proc.fail(proc_zcash_cli_fail);
      zcash_protect_taddresses.empty();
      zcash_protect_taddresses_info.empty();
      zcash_protect_taddresses_info.append("<small><i>No coins available. Start mining or ask someone for some TAZ. See <a target=\"_blank\" href=\"http://faucet.zeropond.com/\">faucet.zeropond.com</a></i></small>");
    }

    function proc_zcash_cli_listunspent(data) {
      var jobj = JSON.parse(data);
      // gather up spendable balances
      $.each(jobj, function(i) {
        if (jobj[i]["spendable"] == true) {
          if (!unspent_balances.hasOwnProperty(jobj[i]["address"])) {
            unspent_balances[jobj[i]["address"]] = jobj[i]["amount"];
          } else {
            unspent_balances[jobj[i]["address"]] = round(unspent_balances[jobj[i]["address"]] + jobj[i]["amount"]);
          }
        }
      });
      zcash_protect_taddresses_info.empty();
      // generate html
      for (var name in unspent_balances) {
        var shortname = name.substring(0, 7) + "..." + name.substring((name.toString().length - 7)).trim();
        zcash_protect_taddresses.append($("<option/>", {
          value: name,
          text: shortname
        }));
        // generate html for balances
        var html = " <small>Balance:</small> <b>" + unspent_balances[name] + "</b> <small>TAZ</small> <i><small>t-addr:</small> " + name + "</i><br />";
        zcash_protect_taddresses_info.append(html);
      }
    }

    function zcash_onClickProtect(e) {
      if (zcash_cli_op_running == true) {
        alert("Operation already in progress...");
        return;
      }
      // make sure we can get a valid balance from the t-addr
      if (zcash_protect_taddresses.val() == null || unspent_balances[zcash_protect_taddresses.val()] == null) {
        alert("No coins available to protect!");
        return;
      }
      var extrafee = round(parseFloat(zcash_protect_extra_fee.val().trim()));
      var maxamount = round(unspent_balances[zcash_protect_taddresses.val().trim()] - extrafee);

      zcash_cli_protect(zcash_protect_taddresses.val().trim(), zcash_protect_zaddresses.val().trim(), maxamount.toFixed(8));
    }


    //
    // Send Tab
    //

    //
    // 	zcash-cli z_listaddresses
    //
    function zcash_cli_list_zaddr() {
      var cmd = [zcashcli, "z_listaddresses"];
      var proc = cockpit.spawn(cmd, {
        err: 'out'
      });
      proc.done(proc_zcash_cli_zaddr);
      proc.fail(proc_zcash_cli_fail);
    }

    function proc_zcash_cli_zaddr(data) {
      var jobj = JSON.parse(data);

      zcash_send_from.empty();
      zcash_protect_zaddresses.empty();

      // gather up private balances
      protected_balance = 0.0;
      $.each(jobj, function(i) {
        protected_balances[jobj[i]] = 0.0;
      });

      // do we need to generate a zaddr?
      if (protected_balances[jobj[0]] == null) {
        alert("Private z-addr not found, generating a new private z-addr!");
        var cmd = [zcashcli, "z_getnewaddress"];
        var proc = cockpit.spawn(cmd, {
          err: 'out'
        });
        proc.done(zcash_cli_list_zaddr);
        proc.fail(proc_zcash_cli_fail);
        return;
      }

      // generate html
      for (var name in protected_balances) {
        var shortname = name.substring(0, 7) + "..." + name.substring((name.toString().length - 7));
        // populate protect tab select options
        zcash_protect_zaddresses.append($("<option/>", {
          value: name,
          text: shortname
        }));
        // populate send tab select options
        zcash_send_from.append($("<option/>", {
          value: name,
          text: shortname
        }));
        // generate html for balances
        var html = " <small>Balance:</small> <b><span id=\"" + name + "\">...</span></b> <small>TAZ</small> <i><small>z-addr:</small> <span id=\"view" + name + "\" ondblclick=\"show_z_listreceivedbyaddress('" + name + "');\">" + name + "</span></i><br />";
        zcash_send_zaddresses_info.append(html);
        // lookup balance for zaddr
        zcash_cli_getbalance_for_zaddr(name);
      }
    }

    function zcash_cli_getbalance_for_zaddr(zaddr) {
      var cmd = [zcashcli, "z_getbalance", zaddr];
      var proc = cockpit.spawn(cmd, {
        err: 'out'
      });
      proc.done(function(data) {
        protected_balances[zaddr] = round(parseFloat(data));
        protected_balance = round(protected_balance + protected_balances[zaddr]);
        $("#" + zaddr).empty();
        $("#" + zaddr).append(protected_balances[zaddr]);
      });
      proc.fail(proc_zcash_cli_fail);
    }

    function zcash_send_add_more(e) {

      e.preventDefault();

      if (zcash_send_to_count >= zcash_send_to_max) {
        alert("You have reached the maximum amount of recipients.");
        return;
      }
      zcash_send_to_count++;

      zcash_send_to_count_output.empty();
      zcash_send_to_count_output.append(zcash_send_to_count);

      var html = "<div class=\"roundedbox\" style=\"display: inline-block;\">";
      html += "<label>To Address</label> <a style=\"float: right;\" href=\"#tabs\" class=\"remove_field\">Remove</a> <br />";
      html += "<input type=\"text\" name=\"zcash-send-to[]\" class=\"zcash-send-to\" /> <br />";
      html += "<label>Send Amount</label><br />";
      html += "<input type=\"text\" name=\"zcash-send-amount[]\" class=\"zcash-send-amount\" value=\"1.00\" /> <br />";
      html += "<label>Memo</label><br />";
      html += "<input type=\"text\" name=\"zcash-send-memo[]\" class=\"zcash-send-memo\" /><br />";
      html += "</div> ";

      zcash_send_to_wrapper.append(html);
    }

    function zcash_onClickSend(e) {

      if (zcash_cli_op_running == true) {
        alert("Operation already in progress...");
        return;
      }
      if (protected_balances[zcash_send_from.val()] == null) {
        alert("Invalid from address.");
        return;
      }

      zcash_send_to = $(".zcash-send-to");
      zcash_send_amount = $(".zcash-send-amount");
      zcash_send_memo = $(".zcash-send-memo");

      var extrafee = round(parseFloat(zcash_send_extra_fee.val()));
      var maxamount = round(protected_balances[zcash_send_from.val()] - extrafee);
      if (maxamount <= 0) {
        alert("Insufficient funds for transaction.");
        return;
      }

      var to_addrs = [];
      var amounts = [];
      var memos = [];

      to_addrs = [].map.call(zcash_send_to, function(input) {
        return input.value;
      });
      amounts = [].map.call(zcash_send_amount, function(input) {
        return input.value;
      });
      memos = [].map.call(zcash_send_memo, function(input) {
        return input.value;
      });

      var confirmHtml = "Are you sure you want to send?\n\n";
      var total_amount = 0.0;
      var count = $(to_addrs).size();
      // early sanity checks and build confirmation html
      for (i = 0; i < count; i++) {
        // ignore empty to_addrs
        if (isEmpty(to_addrs[i])) {
          continue;
        }
        if (isEmpty(amounts[i])) {
          alert("empty amount @ index " + i.toString());
          return;
        }
        if (memos[i].trim().length > 256) {
          alert("Maxlength for memo is 256 chars or 512 bytes.");
          return;
        }

        var shortname = to_addrs[i].substring(0, 7) + "..." + to_addrs[i].substring((to_addrs[i].toString().length - 7));
        confirmHtml += "Amount: " + amounts[i].toString() + " TAZ\n";
        confirmHtml += "To: " + shortname + "\n\n";
        total_amount += parseFloat(amounts[i].toString());
      }

      if (total_amount > maxamount) {
        alert("Insufficient funds for transaction.\nAvailable amount is " + maxamount + " TAZ");
        return;
      }

      confirmHtml += "Extra Fee: " + extrafee.toString() + " TAZ\n";
      confirmHtml += "Total Cost: " + round(total_amount + extrafee).toString() + " TAZ\n\n";

      shortname = zcash_send_from.val().trim().substring(0, 7) + "..." + zcash_send_from.val().trim().substring((zcash_send_from.val().trim().toString().length - 7));
      confirmHtml += "From: " + shortname + "\n";
      confirmHtml += "Begin Balance: " + round(maxamount + extrafee).toString() + " TAZ\n";
      confirmHtml += "Ending Balance: " + round(maxamount - total_amount).toString() + " TAZ\n\n";

      var doTrx = confirm(confirmHtml);
      if (doTrx == true) {
        zcash_cli_sendmany(zcash_send_from.val().trim(), to_addrs, amounts, memos, $("#zcash-wait"));
      }
    }

    function zcash_wait_operation_start(title) {
      zcash_sending_coins = true;
      zcash_wait.empty();
      zcash_wait_status.empty();
      zcash_wait.css("color", "");
      zcash_wait.append("<img id=\"zcash-wait-image\" src=\"zcash-logo-spin.gif\" alt=\"please wait\" align=\"left\" style=\"padding-right: 12px;\" /> <label>"+ title.toString() +"</label> <br />");
      showTab(null, "zcashTabWait");
    }
    function zcash_wait_operation_progress(msg) {
      zcash_wait_status.empty();
      zcash_wait_status.css("color", "blue");
      zcash_wait_status.append(msg);
      showTab(null, "zcashTabWait");
    }
    function zcash_wait_operation_success(msg) {
      zcash_sending_coins = false;
      zcash_wait_status.empty();
      zcash_wait_status.css("color", "green");
      zcash_wait_status.append(msg);
      $("#zcash-wait-image").attr('src', "success.png");
      showTab(null, "zcashTabWait");
    }
    function zcash_wait_operation_fail(msg) {
      zcash_sending_coins = false;
      zcash_wait_status.empty();
      zcash_wait_status.css("color", "red");
      zcash_wait_status.append(msg);
      $("#zcash-wait-image").attr('src', "failed.png");
      showTab(null, "zcashTabWait");
    }

    function zcash_cli_sendmany(from_addr, to_addrs, amounts, memos) {

      // TODO, more sanity checks
      if (to_addrs.length != amounts.length) {
        alert("Fatal Error, array size mismatch!");
        return;
      }

      var ztx = "[";
      var count = $(to_addrs).size();
      for (i = 0; i < count; i++) {

        if (isEmpty(to_addrs[i])) {
          continue;
        }
        // make sure the addr string starts with z or t 
        if ((to_addrs[i].toString().match("^z") == null && to_addrs[i].toString().match("^t")) == null) {
          continue;
        }

        var tx = "{\"amount\": " + parseFloat(amounts[i].toString()).toFixed(8) + ", \"address\": \"" + to_addrs[i].toString() + "\"}, ";
        // memos only work for z-addr
        if (memos[i].length > 0 && to_addrs[i].toString().match("^z") != null)
          tx = "{\"amount\": " + parseFloat(amounts[i].toString()).toFixed(8) + ", \"memo\": \"" + utf8.encode(memos[i].toString().trim()).hexEncode() + "\", \"address\": \"" + to_addrs[i].toString() + "\"}, ";

        ztx += tx;
      }
      // trim last comma and space ", "
      ztx = ztx.substr(0, ztx.length - 2);
      ztx += "]";

      zcash_cli_op_running = true;
      var cmd = [zcashcli, "z_sendmany", from_addr, ztx];

      zcash_output.empty();
      zcash_output.append(cmd.join(" "));

      zcash_wait_operation_start("Sending Funds...");
      var proc = cockpit.spawn(cmd, {
        err: 'out'
      });
      proc.done(proc_zcash_cli_send_opid);
      proc.fail(proc_zcash_cli_fail);
    }

    function zcash_cli_protect(taddr, zaddr, amount) {

      var ztx = "[{\"amount\": " + amount.toString() + ", \"address\": \"" + zaddr.toString() + "\"}]";

      zcash_cli_op_running = true;
      var cmd = [zcashcli, "z_sendmany", taddr, ztx];

      zcash_output.empty();
      zcash_output.append(cmd.join(" "));

      zcash_wait_operation_start("Protecting Coins...");
      var proc = cockpit.spawn(cmd, {
        err: 'out'
      });
      proc.done(proc_zcash_cli_send_opid);
      proc.fail(proc_zcash_cli_fail);
    }

    function proc_zcash_cli_send_opid(data) {
      // grab the opid
      zcash_monitor_opid = data.toString().trim();

      zcash_wait_status.empty();
      zcash_wait_status.css("color", "#18C78F");
      zcash_wait_status.append("checking: " + zcash_monitor_opid);

      // monitor operation id
      var cmd = [zcashcli, "z_getoperationstatus" /*, "[\""+zcash_monitor_opid.toString()+"\"]"*/ ];
      var proc = cockpit.spawn(cmd, {
        err: 'out'
      });
      proc.done(proc_zcash_cli_monitor_opid);
      proc.fail(proc_zcash_cli_fail);
    }

    function do_zcash_cli_monitor_opid() {
      proc_zcash_cli_send_opid(zcash_monitor_opid);
    }

    function proc_zcash_cli_monitor_opid(data) {
      var doMonitor = zcash_monitor_opid.length > 0;

      var jobj = JSON.parse(data);
      $.each(jobj, function(i) {
        if (jobj[i]["id"] == zcash_monitor_opid) {

          zcash_wait_operation_progress(jobj[i]["status"] + ": " + zcash_monitor_opid.toString());

          if (jobj[i]["status"] != "executing") {
            doMonitor = false;
            // complete transaction by getting the result
            var cmd = [zcashcli, "z_getoperationresult" /*, "[\""+zcash_monitor_opid.toString()+"\"]"*/ ];
            var proc = cockpit.spawn(cmd, {
              err: 'out'
            });
            proc.done(proc_zcash_cli_result_opid);
            proc.fail(proc_zcash_cli_fail);
          }
        }
      });

      if (doMonitor) {
        setTimeout(do_zcash_cli_monitor_opid, 1000);
      }
    }

    function proc_zcash_cli_result_opid(data) {

      var jobj = JSON.parse(data);
      $.each(jobj, function(i) {
        if (jobj[i]["id"] == zcash_monitor_opid) {
          if (jobj[i]["result"] != null) {
            zcash_wait_operation_success(jobj[i]["status"] + " txid: " + jobj[i]["result"]["txid"]);
          } else if (jobj[i]["error"] != null) {
            zcash_wait_operation_fail(jobj[i]["status"] + ": " + jobj[i]["error"]["message"]);
          } else {
            zcash_wait_operation_fail(jobj[i]["status"] + ": information not provided");
          }
        }
      });

      zcash_output.empty();
      zcash_output.append(data);

      zcash_monitor_opid = "";
      zcash_cli_op_running = false;

      // update balances
      zcash_cli_getinfo();
    }

    //
    // 	zcash-cli listtransactions
    //
    function zcash_cli_listtransactions() {
      var cmd = [zcashcli, "listtransactions"];
      var proc = cockpit.spawn(cmd);
      proc.done(proc_zcash_cli_listtransactions);
      proc.fail(proc_zcash_cli_fail);
    }

    function proc_zcash_cli_listtransactions(data) {
      var jobj = JSON.parse(data);

      zcash_transaction_info.empty();

      // gather up spendable balances
      $.each(jobj.reverse(), function(i) {
        var date = new Date(parseInt(jobj[i]["time"]) * 1000);
        var html = " <p><span id=\"" + jobj[i]["txid"] + "\">" + date + " - confirmations: " + jobj[i]["confirmations"] + "<br /><i><small>txid:</small> " + jobj[i]["txid"] + "</i><br /> " + jobj[i]["category"] + " <b>" + jobj[i]["amount"] + "</b> <small>TAZ</small> <small>for t-addr: <b>" + jobj[i]["address"] + "</b></small> </span></p>";
        zcash_transaction_info.append(html);
        if (jobj[i]["category"] == "generate") {
          // this coin was mined and verified
          $("#" + jobj[i]["txid"]).css("color", "green");
        } else if (jobj[i]["category"] == "immature") {
          // this coin was just mined and immature
          $("#" + jobj[i]["txid"]).css("color", "red");
        }
      });
    }

    function show_z_listreceivedbyaddress(zaddr) {
      var shortname = zaddr.substring(0, 12) + "..." + zaddr.substring((zaddr.toString().length - 12));
      showDialog("Transactions for " + shortname, "Loading...");
      zcash_cli_z_listreceivedbyaddress(zaddr);
    }

    function zcash_cli_z_listreceivedbyaddress(addr) {
      var cmd = [zcashcli, "z_listreceivedbyaddress", addr.toString().trim()];
      var proc = cockpit.spawn(cmd);
      proc.done(proc_zcash_cli_z_listreceivedbyaddress);
      proc.fail(proc_zcash_cli_fail);
    }

    function proc_zcash_cli_z_listreceivedbyaddress(data) {
      var jobj = JSON.parse(data);
      zcash_dialog_text.empty();
      $.each(jobj.reverse(), function(i) {
        var html = "<p>";
        html += "<small>txid: " + jobj[i]["txid"] + "</small><br />";
        html += "<small>receive</small> <b>" + jobj[i]["amount"] + "</b> <small>TAZ</small> ";
        if (!isEmpty(jobj[i]["memo"])) {
          html += " Memo: <i>" + jobj[i]["memo"].hexDecode() + "</i>";
        }
        html += "</p>";

        zcash_dialog_text.append(html);
      });
    }

    //
    // Console Tab
    //

    //
    // 	zcash-cli console function
    //
    function zcash_cli_input_run() {
      if (zcash_cli_op_running == true) {
        alert("Operation already in progress...");
        return;
      }
      if ($("#zcash-cli-input-cmd").val().length <= 0) {
        alert("Empty command!");
        return;
      }

      zcash_output.empty();
      zcash_cli_op_running = true;

      var cmd = [zcashcli];
      // tokenize the console input ",',[
      var argv = $("#zcash-cli-input-cmd").val().match(/"[^"]+"|\[[^\[]+\]|'[^']+'|\S+/g);
      for (var i in argv) {
        cmd.push(argv[i]);
      }
      var proc = cockpit.spawn(cmd, {
        err: 'out'
      });
      proc.done(proc_zcash_cli_output);
      proc.fail(proc_zcash_cli_fail);
    }

    function proc_zcash_cli_output(data) {
      zcash_cli_op_running = false;
      zcash_output.append(document.createTextNode(data));
    }
  </script>
</body>

</html>
